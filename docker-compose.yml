services:

  # ── Python FastAPI / LangGraph server ─────────────────────────────────────
  # Build context is the repo root so the icon asset files can be COPY'd in.
  server:
    build:
      context: .
      dockerfile: server/Dockerfile
    ports:
      - "8000:8000"
    env_file:
      - .env          # AWS credentials + any overrides (see .env.example)
    environment:
      ASSETS_DIR: /assets
      PYTHONUNBUFFERED: "1"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 15s
      timeout: 5s
      retries: 3

  # ── Next.js client ────────────────────────────────────────────────────────
  # Points WebSocket at the server running on the same Docker host.
  client:
    build:
      context: ./client
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_WS_URL: ws://localhost:8000/ws
    ports:
      - "3000:3000"
    depends_on:
      server:
        condition: service_healthy
